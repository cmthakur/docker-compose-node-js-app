apiVersion: v1
kind: Namespace
metadata:
  name: deployment
  labels:
    app: microservices
---
apiVersion: v1
kind: Service
metadata:
  name: data-tier
  namespace: deployment
  labels:
    app: microservices
spec:
  ports:
    - port: 6379
      protocol: TCP # default
      name: redis # optional when only 1 port
  selector:
    tier: data
  type: ClusterIP # default
---
apiVersion: v1
kind: Pod
metadata:
  name: data-tier
  namespace: deployment
  labels:
    app: microservices
    tier: data
spec:
  containers:
    - name: redis
      image: redis:latest
      ports:
        - containerPort: 6379
      readinessProbe:
        tcpSocket:
          port: 6379
        initialDelaySeconds: 5
        periodSeconds: 5
        timeoutSeconds: 1
        failureThreshold: 3
      livenessProbe:
        tcpSocket:
          port: 6379
        initialDelaySeconds: 10
        periodSeconds: 10
        timeoutSeconds: 1
        failureThreshold: 3
---
apiVersion: v1
kind: Service
metadata:
  name: app-tier
  namespace: deployment
  labels:
    app: microservices
spec:
  ports:
    - port: 8080
  selector:
    tier: app
  type: NodePort
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-tier
  namespace: deployment
  labels:
    app: microservices
    tier: app
spec:
  replicas: 5
  selector:
    matchLabels:
      tier: app
  template:
    metadata:
      labels:
        app: microservices
        tier: app
    spec:
      containers:
        - name: server
          image: nginx:alpine
          ports:
            - containerPort: 8080
          command: ["/bin/sh", "-c"]
          args:
            - |
              cat > /etc/nginx/conf.d/default.conf << 'EOF'
              server {
                  listen 8080;
                  location / {
                      return 200 'App Tier OK - Redis: data-tier:6379\n';
                      add_header Content-Type text/plain;
                  }
                  location /health {
                      return 200 'healthy\n';
                      add_header Content-Type text/plain;
                  }
              }
              EOF
              nginx -g 'daemon off;'
          resources:
            requests:
              cpu: 20m # 20 milliCPU / 0.02 CPU
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 1
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 1
            failureThreshold: 3
          env:
            - name: REDIS_URL
              # Environment variable service discovery
              # Naming pattern:
              #   IP address: <all_caps_service_name>_SERVICE_HOST
              #   Port: <all_caps_service_name>_SERVICE_PORT
              #   Named Port: <all_caps_service_name>_SERVICE_PORT_<all_caps_port_name>
              value: redis://$(DATA_TIER_SERVICE_HOST):$(DATA_TIER_SERVICE_PORT_REDIS)
              # In multi-container example value was
              # value: redis://localhost:6379

---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: app-tier
  namespace: deployment
  labels:
    app: microservices
    tier: app
spec:
  maxReplicas: 5
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: app-tier
  targetCPUUtilizationPercentage: 70
# Equivalent to
# kubectl autoscale deployment app-tier --max=5 --min=1 --cpu-percent=70
